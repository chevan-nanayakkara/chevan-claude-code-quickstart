# ============================================
# .bashrc Configuration
# ============================================

# Version variable (used in myhelp and changelog below)
BASHRC_VERSION="2.4.0"

# Last Updated: January 18, 2026
# Author: Chevan Nanayakkara

#
# Changelog:
# v2.4.0 (2026-01-18) - Added claude-backup function with OneDrive backup on exit
#                     - Added claude-restore function for interactive session restoration
#                     - Added claude-backup-status to view backup history
#                     - Added cb alias as shorthand for claude-backup
#                     - Updated Claude Code aliases (claude-projects, claude-history, claude-status)
#                     - Enhanced myhelp with comprehensive Claude Code section
# v2.0.0 (2026-01-17) - Complete restructure with enhanced bash configuration
#                     - Added git-aware prompt with colors
#                     - Added navigation functions with Claude Code reminders
#                     - Added git helpers and Claude Code aliases
#                     - Added myhelp reference function
#                     - Added SSH agent auto-start
# v1.0.0 (2025-12-07) - Initial setup with basic configuration
# ============================================

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# ============================================
# History Configuration
# ============================================

# Don't put duplicate lines or lines starting with space in history
HISTCONTROL=ignoreboth

# Append to history file, don't overwrite it
shopt -s histappend

# History length
HISTSIZE=1000
HISTFILESIZE=2000

# Check window size after each command
shopt -s checkwinsize

# ============================================
# Colors and Prompt
# ============================================

# Enable color support
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# Git-aware prompt with colors
parse_git_branch() {
    git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/'
}

parse_git_status() {
    # Check if in a git repository
    if git rev-parse --git-dir > /dev/null 2>&1; then
        # Check for uncommitted changes
        if [[ -n $(git status -s 2> /dev/null) ]]; then
            echo "*"
        fi
    fi
}

# Set colorful prompt with git branch and status
# Format: user@host:~/path (branch*) $
PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\[\033[01;33m\]$(parse_git_branch)\[\033[01;31m\]$(parse_git_status)\[\033[00m\]\$ '

# ============================================
# Development Environment Configuration
# ============================================

# NVM Configuration (Node.js version manager)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# Python pip configuration
export PATH="$HOME/.local/bin:$PATH"

# ============================================
# SSH Agent Auto-Start
# ============================================

# Auto-start SSH agent and add GitHub keys
if [ -z "$SSH_AUTH_SOCK" ]; then
   # Start ssh-agent in the background
   eval "$(ssh-agent -s)" > /dev/null

   # Add your GitHub SSH keys (CUSTOMIZE for your key names)
   ssh-add ~/.ssh/id_ed25519 2>/dev/null
   # Add more keys if you have multiple GitHub accounts:
   # ssh-add ~/.ssh/id_ed25519_work 2>/dev/null
   # ssh-add ~/.ssh/id_ed25519_personal 2>/dev/null
fi

# ============================================
# Git Repository Navigation
# ============================================

# --- Top-level navigation (simple aliases) ---
# CUSTOMIZE THESE for your actual repository structure

# Example: Work projects
alias work="cd ~/git/work"

# Example: Personal projects
alias personal="cd ~/git/personal"

# Example: Side projects
alias side="cd ~/git/side-projects"

# Quick navigation
alias gitroot="cd ~/git"
alias repos="cd ~/git && ls -la */"

# Windows shortcuts
alias onedrive="cd ~/OneDrive"
alias documents="cd ~/Documents"
alias downloads="cd ~/Downloads"

# --- Repository navigation with Claude Code reminders (functions) ---
# CUSTOMIZE THESE for repos that have CLAUDE.md files
# Functions provide workflow reminders when you navigate

work-main() {
    cd ~/git/work/main-project
    echo "ğŸ“‚ work/main-project"
    echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
}

personal-project() {
    cd ~/git/personal/my-project
    echo "ğŸ“‚ personal/my-project"
    echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
}

side-project() {
    cd ~/git/side-projects/cool-idea
    echo "ğŸ“‚ side-projects/cool-idea"
    echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
}

# Add more as you create repos with CLAUDE.md files:
# work-api() {
#     cd ~/git/work/api-service
#     echo "ğŸ“‚ work/api-service"
#     echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
# }

# ============================================
# Git Helpers (work in any repo)
# ============================================

alias gs="git status"
alias gd="git diff"
alias gl="git log --oneline -10"
alias ga="git add ."
alias gc="git commit -m"
alias gp="git push"

# ============================================
# Claude Code Helpers
# ============================================

# View recent Claude Code projects
alias claude-projects="ls -lt ~/.claude/projects/ 2>/dev/null | head -20"

# View Claude Code command history (last 20 commands)
alias claude-history="tail -20 ~/.claude/history.jsonl | jq -r '.command' 2>/dev/null || tail -20 ~/.claude/history.jsonl"

# View config
alias claude-config="cat ~/.claude/config.json"

# View recent debug logs
alias claude-logs="ls -lt ~/.claude/debug/ | head -10"

# Quick status - shows what Claude Code has been doing
alias claude-status="echo 'ğŸ“‚ Recent projects:' && ls -lt ~/.claude/projects/ 2>/dev/null | head -5 && echo '' && echo 'ğŸ“ Recent activity:' && ls -lt ~/.claude/ | grep -E 'history|stats' | head -3"

# --- Claude Code Session Backup ---
# Runs Claude Code normally, then backs up sessions to OneDrive when you exit
# This prevents sync conflicts while Claude is running
claude-backup() {
    # Backup configuration (adjust path to match your Windows username and OneDrive location)
    local BACKUP_BASE="$HOME/OneDrive/Documents/claude-code/$(hostname)"
    local CURRENT_BACKUP="$BACKUP_BASE/current"
    local DATED_BACKUP="$BACKUP_BASE/snapshots/$(date +%Y-%m-%d_%H-%M-%S)"

    # Run Claude Code with all passed parameters
    echo "ğŸš€ Starting Claude Code..."
    echo "ğŸ’¡ Tip: Use /rename early to name your session"
    command claude "$@"
    local EXIT_CODE=$?

    # Backup after session ends
    echo ""
    echo "ğŸ“¦ Backing up Claude Code sessions..."

    # Create backup directories
    mkdir -p "$CURRENT_BACKUP"
    mkdir -p "$BACKUP_BASE/snapshots"

    # Backup to 'current' (incremental - doesn't delete removed files)
    rsync -av ~/.claude/ "$CURRENT_BACKUP/" 2>/dev/null

    # Also create a dated snapshot (point-in-time copy)
    rsync -av ~/.claude/ "$DATED_BACKUP/" 2>/dev/null

    if [ $? -eq 0 ]; then
        echo "âœ… Sessions backed up successfully"
        echo "   Current: $CURRENT_BACKUP"
        echo "   Snapshot: $DATED_BACKUP"
        echo "   Time: $(date '+%Y-%m-%d %H:%M:%S')"
    else
        echo "âš ï¸  Backup failed - check permissions"
    fi

    return $EXIT_CODE
}

# View backup status and history
claude-backup-status() {
    local BACKUP_BASE="$HOME/OneDrive/Documents/claude-code/$(hostname)"
    local CURRENT_BACKUP="$BACKUP_BASE/current"

    echo "ğŸ“Š Claude Code Backup Status"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    if [ -d "$CURRENT_BACKUP" ]; then
        echo "ğŸ“‚ Current backup:"
        echo "   Location: $CURRENT_BACKUP"
        echo "   Size: $(du -sh "$CURRENT_BACKUP" 2>/dev/null | cut -f1)"
        echo "   Last modified: $(stat -c "%y" "$CURRENT_BACKUP" 2>/dev/null | cut -d'.' -f1)"
        echo ""
        echo "ğŸ“¸ Recent snapshots:"
        ls -lt "$BACKUP_BASE/snapshots" 2>/dev/null | head -6 | tail -5
    else
        echo "âš ï¸  No backup found at: $BACKUP_BASE"
        echo "ğŸ’¡ Run 'cb' to create first backup"
    fi
}

# Restore Claude Code sessions from backup
claude-restore() {
    local BACKUP_BASE="$HOME/OneDrive/Documents/claude-code/$(hostname)"
    local CURRENT_BACKUP="$BACKUP_BASE/current"

    echo "ğŸ”„ Claude Code Session Restore"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Choose restore source:"
    echo "  1) Latest backup (current/)"
    echo "  2) Specific snapshot (pick from list)"
    echo "  3) Cancel"
    echo ""
    read -r -p "Enter choice (1-3): " choice

    case $choice in
        1)
            if [ ! -d "$CURRENT_BACKUP" ]; then
                echo "âŒ No backup found at: $CURRENT_BACKUP"
                return 1
            fi

            echo ""
            echo "âš ï¸  WARNING: This will overwrite ~/.claude/ with backup from:"
            echo "   $(stat -c "%y" "$CURRENT_BACKUP" 2>/dev/null | cut -d'.' -f1)"
            echo ""
            read -r -p "Are you sure? (yes/no): " confirm

            if [[ "$confirm" == "yes" ]]; then
                echo "ğŸ”„ Restoring from latest backup..."
                rsync -av "$CURRENT_BACKUP/" ~/.claude/
                echo "âœ… Restore complete!"
            else
                echo "âŒ Restore cancelled"
            fi
            ;;
        2)
            echo ""
            echo "Available snapshots:"
            ls -lt "$BACKUP_BASE/snapshots" 2>/dev/null | head -11 | tail -10
            echo ""
            read -r -p "Enter snapshot name (e.g., 2026-01-18_07-30-00): " snapshot

            local SNAPSHOT_PATH="$BACKUP_BASE/snapshots/$snapshot"
            if [ ! -d "$SNAPSHOT_PATH" ]; then
                echo "âŒ Snapshot not found: $SNAPSHOT_PATH"
                return 1
            fi

            echo ""
            echo "âš ï¸  WARNING: This will overwrite ~/.claude/ with snapshot:"
            echo "   $snapshot"
            echo ""
            read -r -p "Are you sure? (yes/no): " confirm

            if [[ "$confirm" == "yes" ]]; then
                echo "ğŸ”„ Restoring from snapshot..."
                rsync -av "$SNAPSHOT_PATH/" ~/.claude/
                echo "âœ… Restore complete!"
            else
                echo "âŒ Restore cancelled"
            fi
            ;;
        3)
            echo "âŒ Restore cancelled"
            ;;
        *)
            echo "âŒ Invalid choice"
            return 1
            ;;
    esac
}

# Shorthand for claude-backup
alias cb='claude-backup'

# ============================================
# Common Aliases
# ============================================

alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# ============================================
# Quick Reference Helper
# ============================================

myhelp() {
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‚ NAVIGATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "work, personal, side          â†’ Top-level (CUSTOMIZE)"
    echo "gitroot, repos                â†’ Git root"
    echo "onedrive, documents, downloads â†’ Windows folders"
    echo ""
    echo "With CLAUDE.md reminders (CUSTOMIZE):"
    echo "  work-main"
    echo "  personal-project"
    echo "  side-project"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¤– CLAUDE CODE"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "claude [--continue]           â†’ Run Claude (no backup)"
    echo "cb [--continue]               â†’ Run Claude + auto-backup on exit"
    echo "                                (cb is short for claude-backup)"
    echo "claude-backup-status          â†’ View backup info"
    echo "claude-restore                â†’ Restore sessions from backup"
    echo ""
    echo "Examples:"
    echo "  claude                      â†’ New session (no backup)"
    echo "  claude --continue           â†’ Resume recent (no backup)"
    echo "  cb --continue               â†’ Resume recent (with backup)"
    echo ""
    echo "Inside session:"
    echo "  /resume                     â†’ Pick from session list"
    echo "  /resume session-name        â†’ Resume specific session"
    echo "  /rename new-name            â†’ Name current session"
    echo ""
    echo "Session info:"
    echo "claude-projects               â†’ Recent projects"
    echo "claude-history                â†’ Command history"
    echo "claude-config                 â†’ View config"
    echo "claude-logs                   â†’ Debug logs"
    echo "claude-status                 â†’ Quick overview"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”§ GIT HELPERS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "gs = git status"
    echo "gd = git diff"
    echo "gl = git log --oneline -10"
    echo "ga = git add ."
    echo "gc = git commit -m 'message'"
    echo "gp = git push"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š GIT STATUS SYMBOLS (in prompt)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "*  = Uncommitted changes"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸªŸ WINDOWS INTEGRATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Access Windows drives: /mnt/c/, /mnt/d/"
    echo "Copy/Paste: Ctrl+Shift+C/V"
    echo "Right-click to paste"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ’¡ TIPS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "type <command>                â†’ See what a command is"
    echo "alias                         â†’ List all aliases"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‹ .bashrc version: $BASHRC_VERSION"
    echo ""
}

# ============================================
# Enable Programmable Completion
# ============================================

if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi
