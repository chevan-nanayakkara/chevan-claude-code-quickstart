# ============================================
# .zshrc Configuration
# ============================================

# Version variable (used in myhelp and changelog below)
ZSHRC_VERSION="2.4.0"

# Last Updated: January 18, 2026
# Author: Chevan Nanayakkara

#
# Changelog:
# v2.4.0 (2026-01-18) - Added startup reminder to use /rename for naming sessions
#                     - Updated statusline to show session ID (first 8 chars) + static /rename tip
#                     - Statusline format: [project] [session-id â€¢ /rename] tokens
# v2.3.0 (2026-01-18) - Added claude-restore function for interactive session restoration
#                     - Removed --delete flag from current backup (safer with multiple sessions)
#                     - Can restore from latest backup or specific snapshot
# v2.2.0 (2026-01-18) - Added claude-backup function with automatic OneDrive backup on exit
#                     - Added claude-backup-status to view backup history
#                     - Sessions now backup to OneDrive with dated snapshots
#                     - Prevents sync conflicts by backing up only after Claude exits
# v2.1.2 (2026-01-18) - Added auto-context-sensing auto-naming to MacOs terminals
# v2.1.1 (2026-01-17) - Fixed Claude Code aliases to use actual directory structure
#                     - Replaced claude-sessions with claude-projects, claude-history, claude-status
#                     - Updated myhelp to reflect new Claude Code commands
# v2.1.0 (2026-01-17) - Added right-side prompt with timestamp (MM/DD HH:MM format)
#                     - Added color reference sections to myhelp (prompt colors, ls colors)
#                     - Reorganized myhelp with most-used items at bottom for efficiency
# v2.0.0 (2026-01-17) - Complete restructure with Oh My Zsh integration
#                     - Added agnoster theme (was robbyrussell default)
#                     - Added navigation functions with Claude Code reminders
#                     - Added git helpers and Claude Code aliases
#                     - Added myhelp reference function
#                     - Installed plugins: autosuggestions, syntax-highlighting
#                     - Added theme alternatives (commented) for easy testing
# v1.0.0 (2025-12-22) - Initial setup with NVM and Pyenv
# ============================================

# ============================================
# Oh My Zsh Configuration
# ============================================

# Path to your Oh My Zsh installation
export ZSH="$HOME/.oh-my-zsh"

# Theme Configuration
ZSH_THEME="agnoster"

# Alternative themes (uncomment to test):
# ZSH_THEME="robbyrussell"              # Default - minimal and fast
# ZSH_THEME="powerlevel10k/powerlevel10k"  # Most popular - run 'p10k configure' after enabling
# ZSH_THEME="spaceship"                 # Clean and informative - shows tool versions
# Note: pure theme requires different setup (installed via npm, configured separately)

# Plugins
# Installed plugins: zsh-autosuggestions, zsh-syntax-highlighting
# To install additional plugins, see: https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins
plugins=(git node npm macos zsh-autosuggestions zsh-syntax-highlighting)

# Load Oh My Zsh
source $ZSH/oh-my-zsh.sh

# ============================================
# Right-side Prompt (Timestamp)
# ============================================

# Show timestamp on right side of prompt
# Format: MM/DD HH:MM (e.g., 01/17 14:23)
# Updates each time prompt is displayed (after each command)
RPROMPT='%F{242}%D{%m/%d %H:%M}%f'

# ============================================
# Auto-set terminal title: app:path
# ============================================

precmd() {
    # Skip if manually overridden
    if [[ -n "$TERMINAL_TITLE_OVERRIDE" ]]; then
        return
    fi

    # Detect app using Claude Code's environment variables
    local app="zsh"
    if [[ "$CLAUDECODE" == "1" ]] || [[ -n "$CLAUDE_CODE_ENTRYPOINT" ]]; then
        app="claude-code"
    fi

    # Get current path with ~ substitution
    local current_path="${PWD/#$HOME/~}"

    # Set title: app:path
    echo -ne "\033]0;${app}:${current_path}\007"
}

# Manual override function
function set-title() {
    export TERMINAL_TITLE_OVERRIDE="$1"
    echo -ne "\033]0;$1\007"
}

# Clear override to restore auto-titling
function clear-title() {
    unset TERMINAL_TITLE_OVERRIDE
}

# ============================================
# Development Environment Configuration
# ============================================

# NVM Configuration (Node.js version manager)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# Pyenv Configuration (Python version manager)
export PYENV_ROOT="$HOME/.pyenv"
command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init -)"

# BasicTeX PATH helper (for pandoc PDF generation)
eval "$(/usr/libexec/path_helper)"

# ============================================
# Git Repository Navigation
# ============================================

# --- Top-level navigation (simple aliases) ---
# CUSTOMIZE THESE for your actual repository structure

# Example: Work projects
alias work="cd ~/git/work"

# Example: Personal projects
alias personal="cd ~/git/personal"

# Example: Side projects
alias side="cd ~/git/side-projects"

# Quick navigation
alias gitroot="cd ~/git"
alias repos="cd ~/git && ls -la */"

# --- Repository navigation with Claude Code reminders (functions) ---
# CUSTOMIZE THESE for repos that have CLAUDE.md files
# Functions provide workflow reminders when you navigate

function work-main() {
    cd ~/git/work/main-project
    echo "ğŸ“‚ work/main-project"
    echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
}

function personal-project() {
    cd ~/git/personal/my-project
    echo "ğŸ“‚ personal/my-project"
    echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
}

function side-project() {
    cd ~/git/side-projects/cool-idea
    echo "ğŸ“‚ side-projects/cool-idea"
    echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
}

# Add more as you create repos with CLAUDE.md files:
# function work-api() {
#     cd ~/git/work/api-service
#     echo "ğŸ“‚ work/api-service"
#     echo "ğŸ’¡ Next: claude â†’ Read CLAUDE.md"
# }

# ============================================
# Git Helpers (work in any repo)
# ============================================

alias gs="git status"
alias gd="git diff"
alias gl="git log --oneline -10"
alias ga="git add ."
alias gc="git commit -m"
alias gp="git push"

# ============================================
# Claude Code Helpers
# ============================================

# View recent Claude Code projects
alias claude-projects="ls -lt ~/.claude/projects/ 2>/dev/null | head -20"

# View Claude Code command history (last 20 commands)
alias claude-history="tail -20 ~/.claude/history.jsonl | jq -r '.command' 2>/dev/null || tail -20 ~/.claude/history.jsonl"

# View config
alias claude-config="cat ~/.claude/config.json"

# View recent debug logs
alias claude-logs="ls -lt ~/.claude/debug/ | head -10"

# Quick status - shows what Claude Code has been doing
alias claude-status="echo 'ğŸ“‚ Recent projects:' && ls -lt ~/.claude/projects/ 2>/dev/null | head -5 && echo '' && echo 'ğŸ“ Recent activity:' && ls -lt ~/.claude/ | grep -E 'history|stats' | head -3"

# --- Claude Code Session Backup ---
# Runs Claude Code normally, then backs up sessions to OneDrive when you exit
# This prevents sync conflicts while Claude is running
function claude-backup() {
    # Backup configuration
    local BACKUP_BASE="$HOME/OneDrive/Documents/claude-code/$USER-$(hostname -s)"
    local CURRENT_BACKUP="$BACKUP_BASE/current"
    local DATED_BACKUP="$BACKUP_BASE/snapshots/$(date +%Y-%m-%d_%H-%M-%S)"

    # Run Claude Code with all passed parameters
    echo "ğŸš€ Starting Claude Code..."
    echo "ğŸ’¡ Tip: Use /rename early to name your session"
    command claude "$@"
    local EXIT_CODE=$?

    # Backup after session ends
    echo "\nğŸ“¦ Backing up Claude Code sessions..."

    # Create backup directories
    mkdir -p "$CURRENT_BACKUP"
    mkdir -p "$BACKUP_BASE/snapshots"

    # Backup to 'current' (incremental - doesn't delete removed files)
    rsync -av ~/.claude/ "$CURRENT_BACKUP/" 2>/dev/null

    # Also create a dated snapshot (point-in-time copy)
    rsync -av ~/.claude/ "$DATED_BACKUP/" 2>/dev/null

    if [ $? -eq 0 ]; then
        echo "âœ… Sessions backed up successfully"
        echo "   Current: $CURRENT_BACKUP"
        echo "   Snapshot: $DATED_BACKUP"
        echo "   Time: $(date '+%Y-%m-%d %H:%M:%S')"
    else
        echo "âš ï¸  Backup failed - check permissions"
    fi

    return $EXIT_CODE
}

# View backup status and history
function claude-backup-status() {
    local BACKUP_BASE="$HOME/OneDrive/Documents/claude-code/$USER-$(hostname -s)"
    local CURRENT_BACKUP="$BACKUP_BASE/current"

    echo "ğŸ“Š Claude Code Backup Status"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    if [ -d "$CURRENT_BACKUP" ]; then
        echo "ğŸ“‚ Current backup:"
        echo "   Location: $CURRENT_BACKUP"
        echo "   Size: $(du -sh "$CURRENT_BACKUP" 2>/dev/null | cut -f1)"
        echo "   Last modified: $(stat -f "%Sm" "$CURRENT_BACKUP" 2>/dev/null)"
        echo ""
        echo "ğŸ“¸ Recent snapshots:"
        ls -lt "$BACKUP_BASE/snapshots" 2>/dev/null | head -6 | tail -5
    else
        echo "âš ï¸  No backup found at: $BACKUP_BASE"
        echo "ğŸ’¡ Run 'claude' to create first backup"
    fi
}

# Restore Claude Code sessions from backup
function claude-restore() {
    local BACKUP_BASE="$HOME/OneDrive/Documents/claude-code/$USER-$(hostname -s)"
    local CURRENT_BACKUP="$BACKUP_BASE/current"

    echo "ğŸ”„ Claude Code Session Restore"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Choose restore source:"
    echo "  1) Latest backup (current/)"
    echo "  2) Specific snapshot (pick from list)"
    echo "  3) Cancel"
    echo ""
    read -r "choice?Enter choice (1-3): "

    case $choice in
        1)
            if [ ! -d "$CURRENT_BACKUP" ]; then
                echo "âŒ No backup found at: $CURRENT_BACKUP"
                return 1
            fi

            echo ""
            echo "âš ï¸  WARNING: This will overwrite ~/.claude/ with backup from:"
            echo "   $(stat -f "%Sm" "$CURRENT_BACKUP" 2>/dev/null)"
            echo ""
            read -r "confirm?Are you sure? (yes/no): "

            if [[ "$confirm" == "yes" ]]; then
                echo "ğŸ”„ Restoring from latest backup..."
                rsync -av "$CURRENT_BACKUP/" ~/.claude/
                echo "âœ… Restore complete!"
            else
                echo "âŒ Restore cancelled"
            fi
            ;;
        2)
            echo ""
            echo "Available snapshots:"
            ls -lt "$BACKUP_BASE/snapshots" 2>/dev/null | head -11 | tail -10
            echo ""
            read -r "snapshot?Enter snapshot name (e.g., 2026-01-18_07-30-00): "

            local SNAPSHOT_PATH="$BACKUP_BASE/snapshots/$snapshot"
            if [ ! -d "$SNAPSHOT_PATH" ]; then
                echo "âŒ Snapshot not found: $SNAPSHOT_PATH"
                return 1
            fi

            echo ""
            echo "âš ï¸  WARNING: This will overwrite ~/.claude/ with snapshot:"
            echo "   $snapshot"
            echo ""
            read -r "confirm?Are you sure? (yes/no): "

            if [[ "$confirm" == "yes" ]]; then
                echo "ğŸ”„ Restoring from snapshot..."
                rsync -av "$SNAPSHOT_PATH/" ~/.claude/
                echo "âœ… Restore complete!"
            else
                echo "âŒ Restore cancelled"
            fi
            ;;
        3)
            echo "âŒ Restore cancelled"
            ;;
        *)
            echo "âŒ Invalid choice"
            return 1
            ;;
    esac
}

# Optional: Uncomment to make 'claude' always backup (or just use 'claude-backup' manually)
# alias claude='claude-backup'

# Shorthand for claude-backup
alias cb='claude-backup'

# ============================================
# Quick Reference Helper
# ============================================

function myhelp() {
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¨ THEME TESTING"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Edit ~/.zshrc to change ZSH_THEME"
    echo "Current: agnoster"
    echo "Available: robbyrussell, powerlevel10k,"
    echo "           spaceship, pure"
    echo "To test temporarily: ZSH_THEME='robbyrussell' source ~/.zshrc"
    echo "To make permanent: edit ~/.zshrc and change ZSH_THEME"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¨ PROMPT COLORS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "User@host: White on grey = normal user"
    echo "Directory: Blue background"
    echo ""
    echo "Git status background colors:"
    echo "  Green  = Clean repo (no changes)"
    echo "  Yellow = Uncommitted changes"
    echo "  Red    = Conflicts or errors"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“ ls COLORS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Blue   = Directories"
    echo "Cyan   = Symbolic links"
    echo "Purple = Special permissions"
    echo "White  = Regular files"
    echo "Green  = Executable files"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‚ NAVIGATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "work, personal, side          â†’ Top-level (CUSTOMIZE)"
    echo "gitroot, repos                â†’ Git root"
    echo ""
    echo "With CLAUDE.md reminders (CUSTOMIZE):"
    echo "  work-main"
    echo "  personal-project"
    echo "  side-project"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¤– CLAUDE CODE"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "claude [--continue]           â†’ Run Claude (no backup)"
    echo "cb [--continue]               â†’ Run Claude + auto-backup on exit"
    echo "                                (cb is short for claude-backup)"
    echo "claude-backup-status          â†’ View backup info"
    echo "claude-restore                â†’ Restore sessions from backup"
    echo ""
    echo "Examples:"
    echo "  claude                      â†’ New session (no backup)"
    echo "  claude --continue           â†’ Resume recent (no backup)"
    echo "  cb --continue               â†’ Resume recent (with backup)"
    echo ""
    echo "Inside session:"
    echo "  /resume                     â†’ Pick from session list"
    echo "  /resume session-name        â†’ Resume specific session"
    echo "  /rename new-name            â†’ Name current session"
    echo ""
    echo "Session info:"
    echo "claude-projects               â†’ Recent projects"
    echo "claude-history                â†’ Command history"
    echo "claude-config                 â†’ View config"
    echo "claude-logs                   â†’ Debug logs"
    echo "claude-status                 â†’ Quick overview"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”§ GIT HELPERS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "gs = git status"
    echo "gd = git diff"
    echo "gl = git log --oneline -10"
    echo "ga = git add ."
    echo "gc = git commit -m 'message'"
    echo "gp = git push"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š GIT STATUS SYMBOLS (in prompt)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "(nothing) = Clean repo"
    echo "âœ—         = Uncommitted changes"
    echo "Â±         = Staged changes (ready to commit)"
    echo "âœ“         = Everything committed"
    echo "âš¡        = Stash exists"
    echo "â†“         = Behind remote (need to pull)"
    echo "â†‘         = Ahead of remote (need to push)"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ’¡ TIPS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "type <command>                â†’ See what a command is"
    echo "alias                         â†’ List all aliases"
    echo "functions | grep '()'         â†’ List all functions"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‹ .zshrc version: $ZSHRC_VERSION"
    echo ""
}

# ============================================
# Oh My Zsh Plugin Notes
# ============================================
#
# Installed plugins:
# - zsh-autosuggestions: Suggests commands as you type (press â†’ to accept)
# - zsh-syntax-highlighting: Highlights valid/invalid commands in real-time
#
# If plugins aren't working, verify installation:
# ls ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/
#
# Should show: zsh-autosuggestions, zsh-syntax-highlighting
#
# To reinstall:
# git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
# git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
#
# Then reload: source ~/.zshrc

# ============================================
# Theme Testing Guide
# ============================================
#
# To test different themes temporarily (without editing this file):
#
# In terminal, run:
#   ZSH_THEME="robbyrussell" source ~/.zshrc
#   ZSH_THEME="spaceship" source ~/.zshrc
#   ZSH_THEME="powerlevel10k/powerlevel10k" source ~/.zshrc
#
# This changes theme for current session only.
# To make permanent, edit ZSH_THEME line above and reload.
#
# Theme comparison:
# - robbyrussell:    Minimal, fast, default
# - agnoster:        Powerline style, good git status (CURRENT)
# - powerlevel10k:   Most customizable, very fast, interactive setup
# - spaceship:       Clean, shows tool versions (Node/Python)
# - pure:            Ultra minimal, async (requires npm install -g pure-prompt)
#
# Note: agnoster, powerlevel10k require Meslo Nerd Font
# (already installed via: brew install font-meslo-lg-nerd-font)
# Set in Terminal â†’ Preferences â†’ Profiles â†’ Font â†’ MesloLGS NF
